---
title: "RandomForest_Prediction"
author: "Gabriel Yarleque"
date: "4/20/2020"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    toc_depth: 5
    toc: yes
vignette: >
  %\VignetteIndexEntry{RandomForest_Prediction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
# knitr::opts_knit$set(root.dir = "~/external/data/")
knitr::opts_chunk$set(echo = TRUE)

```


```{r, eval= FALSE}
############################################################################

#Install libraries
library(sf)
library(randomForest)
library(dplyr)
require(caTools)
library(raster)
library(rgdal)
```


# Random Forest Regression

```{r, error = TRUE, warning = FALSE, message = FALSE, fig.width = 6, fig.height = 4, fig.align = 'center'}
##############################   Random Forest Regression at 2500###############################

# Data reading
DS <- read.csv('D:\\rproject\\Imperv_connect_Struct_Traffic_NDSI.csv', header = T) 


# Filter values using 2500 as the scale of best influence
DS_2500 <- DS %>% filter(Buffer == "Buffer 2500 (m)") %>% dplyr::select(-c(X,Buffer, SiteName, Biophony, Anthrophony))

# Scale variable values except NDSI values 
DS_2500_scaled <- DS_2500[,1:4]/255

# Use mutate to add NDSI values back to the table. 
DS_2500_scaled <- DS_2500_scaled %>% mutate("NDSI" = DS_2500$NDSI)

# Create training and testing samples
sample = sample.split(DS_2500$NDSI, SplitRatio = .75)
train = subset(DS_2500, sample == TRUE)
test  = subset(DS_2500, sample == FALSE)

# Check out the dimensions of each sample set
dim(train)
dim(test)

# Create RandomForest Model
set.seed(100)
rf_2500 <- randomForest(NDSI ~., data=DS_2500, mtry= 2, importance = TRUE, na.action=na.omit)

print(rf_2500)

# Show "importance" of variables: higher value means more important:
round(importance(rf_2500), 2)

# Visualize Variable Importance Plot
varImpPlot(rf_2500, main = "Variable Importance at 2500 buffer level")
```


# Predictive Modeling 

```{r, error = TRUE, warning = FALSE, message = FALSE, fig.width = 6, fig.height = 4, fig.align = 'center'}
# Read raster images for 
Imperv <- raster("D:\\rproject\\lc2500_tiffiles\\lc2500_imperv.tif")
Connectdness <- raster("D:\\rproject\\lc2500_tiffiles\\lc2500_connect.tif")
Structure <- raster("D:\\rproject\\lc2500_tiffiles\\lc2500_structure.tif")
Traffic <- raster("D:\\rproject\\lc2500_tiffiles\\lc2500_traffic.tif")

# Create a raster stack
my_stack <- stack(Imperv, Connectdness, Structure, Traffic)
names(my_stack) <- c("Imperv", "Connectdness", "Structure", "Traffic")

# Use raster::predict to predict NDSI values across the landscape
ndsi_pred <- raster::predict(object = my_stack, model=rf_2500, type = 'response', index = 5)
ndsi_pred

# Plot NDSI prediction layer 
plot (ndsi_pred)

# Display NDSI prediction layer with sample locations. First, set the CRS for the sampling locations to match the one from the raster image
sites <- st_read ('D:\\rproject\\sites\\AcousticSampleLocations.shp')
sites <- st_transform(x = sites, crs = st_crs(ndsi_pred))

plot_noaxes(ndsi_pred, main = "NDSI Prediction")
plot(st_geometry(sites), add = TRUE)

# Plot variables and predicted NDSI raster image

# Rename ndsi_pred
names(ndsi_pred) <- c("NDSI_Prediction")

stack_final <- stack(my_stack,ndsi_pred)
plot_noaxes(stack_2)
```


