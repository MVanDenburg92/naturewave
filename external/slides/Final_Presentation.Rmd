---
title: "NatureWave"
author: "Miles Van Denburg & Gabriel Yarleque"
date: "5/4/2020"
output: slidy_presentation


---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Introduction

## __Objective:__ 

- Assess the relationships between habitat quality and biodiversity in a highly fragmented and human-dominated forested landscape in Massachusetts, through a geospatial analysis lens, integrating spatial analysis, remote sensing, and soundscape ecology. 

- Understand the relationships between community acoustic and habitat configuration.

## __Package: NatureWave__

- Package which analyzes processed Sound Index data for NDSI (Normalized Difference Sound Index)

- Assesses the correlations between sound indices and ecological variables of interest taking into account different landscape metrics for Massachusets at different scales of influence.

- Evaluates the importance of ecological variables at multiple scales and predicts NDSI values accross the entire study area. 


# Acoustic Indices

Acoustic indices allow an aggregation of acoustic signals to represent the overall acoustic community diversity of the landscape. 

The Normalized Difference Soundscape Index (NDSI) characterizes soundscape properties as such to allow the identification of human influence of the landscape through the partitioning of soundscapes into biophony (sounds from biodiversity) and anthrophony (sounds from humans). 

This partitioning allows the classification of a particular location based on its ecological and anthropic characteristics.

__NDSI = (biophony - anthrophony)/ (biophony + anthrophony)__

This project provides a less costly-reproducible approach to measurement and analysis and contributes to the applications of remote sensing technologies in conservation planning and monitoring of habitat quality.

# Data

- Conservation Assessment and Prioritization System (CAPS) Landscape Metrics

Statewide Massachusetts Assessment: November 2011
http://jamba.provost.ads.umass.edu/web/caps2011/CAPS2011data.htm

__* Imperviousness:__ http://jamba.provost.ads.umass.edu/web/CAPS2011/tiffzips/metricsraw/imperv.zip


__* Connectedness:__ http://jamba.provost.ads.umass.edu/web/CAPS2011/tiffzips/metricsraw/connect.zip
      

__* Vegetative structure:__ http://jamba.provost.ads.umass.edu/web/caps2011/tiffzips/settings/structure.zip
      

__* Road traffic:__ http://jamba.provost.ads.umass.edu/web/CAPS2011/tiffzips/metricsraw/traffic.zip

-Dr. Florencia Sangermano collected recordings at 11 different sites in Central Mass. over the course of 3 months between June and August. 


# Methodology

## __Preliminary Work__

```{r,  eval = FALSE, echo = TRUE}
# Focal Mean using circular focalWeight at a buffer of 2500 meters

# Create a raster stack
landcover_ls <- list(Imperv, Connectedness, Structure, Traffic)
names(landcover_ls) <- c("Imperv", "Connectedness", "Structure", "Traffic")

my_brick <- brick(landcover_ls)


# b <- brick(file.path(path_in, "lc2500_brick.tif"))  # correct, reads in whole brick

# mass <- st_as_sf(map(database = "state", plot = FALSE, fill = TRUE)) %>% lwgeom::st_make_valid() %>% filter(ID == "massachusetts")

# par(mfrow = c(2, 2), mar = c(.5, 0, 2, 6))
plot(my_brick, axes = FALSE, box = FALSE)

```



## __Random Forest__

```{r, eval = FALSE, echo = TRUE}
# Create RandomForest Model
set.seed(100)
rf_2500 <- randomForest(NDSI ~., data=DS_2500_scaled, mtry= 2, importance = TRUE, na.action=na.omit)

randomForest::varImpPlot(rf_2500, main = "Variable Importance at 2500 buffer level")

```

## __Preditive modeling__


```{r, eval = FALSE, echo=TRUE}
# Use raster::predict to predict NDSI values across the landscape
ndsi_pred <- raster::predict(object = new_stack, model=rf_2500, type = 'response', index = 5)
ndsi_pred
```


# Results from Preliminary work

## __Linear Modeling__

```{r, echo=FALSE, out.width='70%', fig.show='hold', fig.align='center', fig.width=3, fig.height=3}

knitr::include_graphics(here::here("external/slides/figures/NDBIRSquared_Final.png"))

knitr::include_graphics(here::here("external/slides/figures/NDBI_NDSIFinal.png"))

knitr::include_graphics(here::here("external/slides/figures/Imperv_struture_Connect_Traffic_NDSI.png"))


knitr::include_graphics(here::here("external/slides/figures/NDVI_NDSIFinal.png"))

```

# Graph results

```{r, error = TRUE, warning = FALSE, message = FALSE, fig.width = 6, fig.height = 4, fig.align = 'center'}
#[5]

library(ggplot2)

linear_rsquared_new <- read.csv("../inst/extdata/linear_rsquared_traffic_included.csv")

RSquaredPlot_NDSI <- ggplot(data = linear_rsquared_new) +
  geom_line(aes(x = linear_rsquared_new$Buffer, y = linear_rsquared_new$NDSI_Imperv_lm,
                color = 'Imperv')) +
  geom_line(aes(x = linear_rsquared_new$Buffer, y = linear_rsquared_new$NDSI_Structure_lm,
                color = 'Structure')) +
  geom_line(aes(x = linear_rsquared_new$Buffer, y = linear_rsquared_new$NDSI_Connect_lm,
                color = 'Connect')) +
 geom_line(aes(x = linear_rsquared_new$Buffer, y = linear_rsquared_new$NDSI_Traffic_lm,
               color = 'Traffic')) + scale_x_log10() +
  labs(title = "Mean NDSI ~ R squared of metrics", x ="Focal Distance (meters)",
       y = "R squared of metrics")

plotly::ggplotly(RSquaredPlot_NDSI)
```


# Surfaces

```{r}
# insert 4 raster surfaces here
```


# Results from Random Forest

## __Variable Importance plot__

```{r, error = TRUE, warning = FALSE, message = FALSE, fig.width = 6, fig.height = 4, fig.align = 'center'}

# Variable importance plot

# Show "importance" of variables: higher value means more important:
round(randomForest::importance(rf_2500), 2)

# Visualize Variable Importance Plot
randomForest::varImpPlot(rf_2500, main = "Variable Importance at 2500 buffer level")
```


# Results from Â¨Predictive Modeling

## __NDSI Predidictive surface__

```{r, error = TRUE, warning = FALSE, message = FALSE, fig.width = 6, fig.height = 4, fig.align = 'center'}

library(leaflet)
# Insert Predicted NDSI Surface

# Use raster::predict to predict NDSI values across the landscape
ndsi_pred <- raster::predict(object = my_brick, model=rf_2500, type = 'response', index = 5)
#ndsi_pred


## class      : RasterLayer 
## dimensions : 2513, 2124, 5337612  (nrow, ncol, ncell)
## resolution : 30, 30  (x, y)
## extent     : 133470, 197190, 863430, 938820  (xmin, xmax, ymin, ymax)
## crs        : +proj=lcc +lat_1=41.71666666666667 +lat_2=42.68333333333333 +lat_0=41 +lon_0=-71.5 +x_0=200000 +y_0=750000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs 
## source     : memory
## names      : layer 
## values     : 0.2626267, 0.7772814  (min, max


# Display NDSI prediction layer with sample locations. First, set the CRS for the sampling locations to match the one from the raster image

sites <- st_read(dsn = "../inst/extdata/sample_sites_projected.shp")
sites <- st_transform(x = sites, crs = st_crs(ndsi_pred))

# Plot variables and predicted NDSI raster image

# Rename ndsi_pred
names(ndsi_pred) <- c("NDSI_Prediction")



#Code below creates an interactive leaflet map with clickable sites

pal2 <- colorNumeric(c("#F2F2F2FF","#EEB99FFF", "#EAB64EFF","#E6E600FF","#00A600FF"), values(ndsi_pred), na.color = "transparent")
pal3 <- colorNumeric(c("#00A600FF","#E6E600FF","#EAB64EFF","#EEB99FFF","#F2F2F2FF"), values(ndsi_pred), na.color = "transparent")

leaflet() %>% addTiles() %>% addCircleMarkers(lng = sites$Long, lat = sites$Lat, weight = 1, popup = sites$Site) %>% 
  addRasterImage(ndsi_pred, colors = pal2, opacity = 0.8) %>%
  addLegend(pal = pal3, values = values(ndsi_pred), labFormat = labelFormat(transform = function(x) sort(x, decreasing = TRUE)),title = "Predicted NDSI Values")

```


# Conclusion and Discussion

- The scale of best influence for NDSI values is at 2500 m buffer from the sampling location

- Imperviousness and Traffic are the most important variables at predicting NDSI values

## __Future work:__

- Test further variables such as ecological integrity and micro climate alterations
